<!-- Uygulamalar/blok.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Blok Okuma + ChatGPT Metin Üretme</title>
<style>
body{
  font-family:Arial,sans-serif;
  margin:0;
  padding:0;
  height:100vh;
}
#container{
  display:flex;
  height:100vh;
}

/* SOL PANEL */
#settings{
  width:260px;
  background:#f0f0f0;
  border-right:1px solid #ccc;
  display:flex;
  flex-direction:column;
  height:100vh;
}
#settingsContent{
  flex:1;
  overflow-y:auto;
  padding:15px;
}
#wordStats{
  background:#e8e8e8;
  padding:8px;
  font-size:12px;
  border-top:1px solid #ccc;
}
#quizStatsPanel{
  background:#e8e8e8;
  padding:8px;
  font-size:12px;
  border-top:1px solid #ccc;
}
.section{
  margin-bottom:12px;
  padding-bottom:8px;
  border-bottom:1px solid #ccc;
}
#settings label,
#settings input,
#settings select,
#settings button{
  width:100%;
  margin-bottom:6px;
  font-size:12px;
  box-sizing:border-box;
}
#settings h3{
  margin:0 0 6px;
  font-size:14px;
}
#settings button{
  padding:6px;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.primary{background:#007bff;color:white}
.secondary{background:#6c757d;color:white}

/* SAĞ PANEL (METİN + SORULAR) */
#rightPanel{
  flex:1;
  display:flex;
  flex-direction:column;
  background:white;
}

/* METİN ALANI */
#textDisplay{
  flex:1;
  padding:20px;
  font-family:monospace;
  font-size:20px;
  background:white;
  overflow-y:auto;
  white-space:pre-wrap;
  line-height:1.6;
}
.hiddenWord{color:#f5f5f5}
.visibleWord{color:black}
.line{display:block}

/* SORU ALANI */
#questionContainer{
  padding:10px 20px 10px 20px;
  overflow-y:auto;
}
.question{
  margin-bottom:15px;
}
.question p{
  margin:0 0 6px 0;
}
.options{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.optionBtn{
  text-align:left;
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:4px;
  background:#f8f8f8;
  cursor:pointer;
  font-size:14px;
}
.optionBtn.selected{
  border-color:#007bff;
  background:#e6f0ff;
}
.optionBtn.correct{
  background:#c9f7c2 !important;
  border-color:#28a745 !important;
}
.optionBtn.wrong{
  background:#f8d7da !important;
  border-color:#dc3545 !important;
}

/* TESTİ BİTİR BUTONU */
#finishBtn{
  margin:0 20px 15px 20px;
  padding:8px 12px;
  border:none;
  border-radius:4px;
  background:#28a745;
  color:white;
  cursor:pointer;
  font-size:14px;
  align-self:flex-start;
  display:none; /* başta gizli */
}
</style>
</head>

<body>

<div id="container">

  <div id="settings">

    <div id="settingsContent">

      <!-- API BÖLÜMÜ (Bu sayfada sorgulansın) -->
      <div class="section">
        <h3>1) API Durumu</h3>
        <div id="apiStatusLine" style="font-weight:bold;margin-bottom:6px;"></div>

        <button class="secondary" id="apiChangeBtn" type="button" style="display:none;">API değiştir</button>
        <button class="secondary" id="apiCancelChangeBtn" type="button" style="display:none;">İptal</button>

        <div id="apiEntry" style="display:none;">
          <input id="apiKeyInput" type="password" placeholder="OpenAI API anahtarı (sk-...)" style="width:100%;margin-bottom:6px;box-sizing:border-box;">
          <button class="primary" id="apiSaveBtn" type="button">API Doğrula ve Kaydet</button>
          <div id="apiSaveStatus" style="font-size:11px;margin-top:6px;"></div>

          <div style="font-size:11px;margin-top:6px;">
            API kodu almak için:
            <a href="https://platform.openai.com/api-keys"
               target="_blank"
               rel="noopener noreferrer">
               Link
            </a>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h3>2) Metin</h3>
        <label>Yaş Aralığı</label>
        <select id="ageGroupInput">
          <option value="">Seçiniz</option>
          <option value="7-9">7-9</option>
          <option value="10-12">10-12</option>
          <option value="13-15">13-15</option>
          <option value="16-18">16-18</option>
          <option value="18+">18+</option>
        </select>

        <label>Zorluk Seviyesi</label>
        <select id="levelInput">
          <option value="">Seçiniz</option>
          <option value="kolay">Kolay</option>
          <option value="orta">Orta</option>
          <option value="zor">Zor</option>
        </select>

        <label>Metin Kaynağı</label>
        <div style="display:flex;gap:6px;margin-bottom:6px;">
          <label style="display:flex;align-items:center;gap:6px;width:auto;margin:0;">
            <input type="radio" name="textSource" id="srcAI" value="ai" checked style="width:auto;margin:0;">
            Yaş-zorluk-konuya göre oluştur
          </label>
          <label style="display:flex;align-items:center;gap:6px;width:auto;margin:0;">
            <input type="radio" name="textSource" id="srcReady" value="ready" style="width:auto;margin:0;">
            Hazır metin seç
          </label>
        </div>

        <div id="readyTextBox" style="display:none;margin-bottom:6px;">
          <select id="readyTextSelect">
            <option value="">Hazır metin seçiniz</option>
          </select>
          <button class="secondary" id="loadReadyBtn" type="button">Hazır Metni Yükle</button>
          <div id="readyStatus" style="font-size:11px;margin-top:4px;"></div>
        </div>

        <label>Konu</label>
        <input type="text" id="topicInput" placeholder="Örn: Güneş Sistemi">

        <button class="primary" id="generateTextBtn">Metin Oluştur</button>
        <div id="generateStatus" style="font-size:11px;margin-top:4px;"></div>
      </div>

      <div class="section">
        <h3>3) Okuma</h3>
        <label>Süre (ms) – 5 harf</label>
        <input type="number" id="timeInput" value="300" step="50" min="50">
        <label>Blok (en fazla 3)</label>
        <select id="blockCountInput">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
        <button class="primary" id="startBtn">Başlat</button>
        <button class="secondary" id="pauseBtn">Duraklat</button>
        <button class="secondary" id="stopBtn">Durdur</button>
      </div>

    </div>

    <div id="wordStats">
      Toplam: 0<br>
      Ortalama: 0<br>
      Hız: 0 dk
    </div>
    <div id="quizStatsPanel">
      Test sonucu yok.
    </div>

  </div>

  <!-- SAĞ PANEL: METİN + SORULAR -->
  <div id="rightPanel">
    <div id="textDisplay"></div>
    <button id="finishBtn">Testi Bitir</button>
    <div id="questionContainer"></div>
  </div>

</div>

<script>
/* ========= SABİT: METİNLER KLASÖRÜ (GitHub Pages) ========= */
const METINLER_BASE_URL = "https://kronosegitim.github.io/HizliOkuma/Metinler/";

/* ========= KULLANICI KODU GÜVENLİK KONTROLÜ ========= */
(function ensureUserCode(){
  const code = localStorage.getItem("USER_CODE");
  if(!code || !code.trim()){
    // Doğrudan link ile gelindiyse, ana sayfaya yönlendir
    alert("Önce kullanıcı kodu ile giriş yapmalısınız.");
    window.location.href = "AnaSayfa.html";
  }
})();

/* ========= API ANAHTARI DURUMU ========= */

/* index.html ile aynı key: USER_API_KEY */
function getApiKey(){
  return localStorage.getItem("USER_API_KEY") || "";
}

const apiStatusLine = document.getElementById("apiStatusLine");
const apiEntry      = document.getElementById("apiEntry");
const apiKeyInput   = document.getElementById("apiKeyInput");
const apiSaveBtn    = document.getElementById("apiSaveBtn");
const apiSaveStatus = document.getElementById("apiSaveStatus");

const apiChangeBtn       = document.getElementById("apiChangeBtn");
const apiCancelChangeBtn = document.getElementById("apiCancelChangeBtn");

let apiEditing = false;

async function verifyApiKey(key){
  // Basit doğrulama: /v1/models endpoint'i
  const res = await fetch("https://api.openai.com/v1/models", {
    headers: { "Authorization": "Bearer " + key }
  });
  return res.ok;
}

async function handleApiSave(){
  const key = (apiKeyInput.value || "").trim();
  apiSaveStatus.textContent = "";
  if(!key || key.length < 10){
    apiSaveStatus.textContent = "Lütfen geçerli bir anahtar girin.";
    apiSaveStatus.style.color = "red";
    return;
  }

  apiSaveBtn.disabled = true;
  apiSaveStatus.textContent = "API kontrol ediliyor...";
  apiSaveStatus.style.color = "blue";

  try{
    const ok = await verifyApiKey(key);
    if(ok){
      localStorage.setItem("USER_API_KEY", key);
      apiSaveStatus.textContent = "✅ API geçerli ve kaydedildi.";
      apiSaveStatus.style.color = "green";
      apiEditing = false;
      updateApiStatusLine();
    }else{
      localStorage.removeItem("USER_API_KEY");
      apiSaveStatus.textContent = "❌ API geçersiz. Lütfen tekrar deneyin.";
      apiSaveStatus.style.color = "red";
      apiEditing = false;
      updateApiStatusLine();
    }
  }catch(err){
    console.error(err);
    apiSaveStatus.textContent = "⚠ Bağlantı hatası. Lütfen tekrar deneyin.";
    apiSaveStatus.style.color = "orange";
  }finally{
    apiSaveBtn.disabled = false;
  }
}

if(apiSaveBtn){
  apiSaveBtn.addEventListener("click", handleApiSave);
}

if(apiChangeBtn){
  apiChangeBtn.addEventListener("click", ()=>{
    apiEditing = true;
    apiSaveStatus.textContent = "";
    if(apiEntry) apiEntry.style.display = "block";
    if(apiChangeBtn) apiChangeBtn.style.display = "none";
    if(apiCancelChangeBtn) apiCancelChangeBtn.style.display = "block";
    if(apiKeyInput) apiKeyInput.value = "";
    if(apiKeyInput) apiKeyInput.focus();
  });
}
if(apiCancelChangeBtn){
  apiCancelChangeBtn.addEventListener("click", ()=>{
    apiEditing = false;
    apiSaveStatus.textContent = "";
    updateApiStatusLine();
  });
}

function updateApiStatusLine(){
  const key = getApiKey();
  const hasKey = (key && key.trim().length > 10);

  if(hasKey){
    apiStatusLine.textContent = "✅ API kayıtlı";
    apiStatusLine.style.color = "green";

    if(apiEditing){
      if(apiEntry) apiEntry.style.display = "block";
      if(apiChangeBtn) apiChangeBtn.style.display = "none";
      if(apiCancelChangeBtn) apiCancelChangeBtn.style.display = "block";
      if(apiKeyInput) apiKeyInput.value = "";
    }else{
      if(apiEntry) apiEntry.style.display = "none";
      if(apiChangeBtn) apiChangeBtn.style.display = "block";
      if(apiCancelChangeBtn) apiCancelChangeBtn.style.display = "none";
      if(apiKeyInput) apiKeyInput.value = "";
    }
  }else{
    apiStatusLine.textContent = "❌ API kayıtlı değil";
    apiStatusLine.style.color = "red";
    apiEditing = false;
    if(apiEntry) apiEntry.style.display = "block";
    if(apiChangeBtn) apiChangeBtn.style.display = "none";
    if(apiCancelChangeBtn) apiCancelChangeBtn.style.display = "none";
  }
}

updateApiStatusLine();

/* ========= METİN KAYNAĞI (AI / HAZIR TXT) ========= */

const srcAI = document.getElementById("srcAI");
const srcReady = document.getElementById("srcReady");
const readyTextBox = document.getElementById("readyTextBox");
const readyTextSelect = document.getElementById("readyTextSelect");
const loadReadyBtn = document.getElementById("loadReadyBtn");
const readyStatus = document.getElementById("readyStatus");

function updateTextSourceUI(){
  const isReady = srcReady && srcReady.checked;
  if(readyTextBox) readyTextBox.style.display = isReady ? "block" : "none";
  const topicInputEl = document.getElementById("topicInput");
  if(topicInputEl) topicInputEl.disabled = isReady ? true : false;
}

if(srcAI) srcAI.addEventListener("change", updateTextSourceUI);
if(srcReady) srcReady.addEventListener("change", updateTextSourceUI);
updateTextSourceUI();

/* 
   GitHub'da hazır metin/soru TXT dosyaları:
   - Metinler/list.json  (GitHub Pages: https://kronosegitim.github.io/HizliOkuma/Metinler/list.json)
   - Metinler/xxx.txt

   list.json örneği:
   [
     {"label":"Dikkatsizlik (7-9 / Kolay)","file":"Dikkatsizlik.txt"},
     {"label":"Frig Kralı (10-12 / Orta)","file":"139-Frig_Kralı.txt"}
   ]
*/
async function loadReadyList(){
  if(!readyTextSelect) return;
  try{
    const res = await fetch(METINLER_BASE_URL + "list.json", { cache:"no-store" });
    if(!res.ok) throw new Error("list.json bulunamadı");
    const arr = await res.json();
    if(!Array.isArray(arr) || !arr.length) return;

    while(readyTextSelect.options.length > 1) readyTextSelect.remove(1);

    arr.forEach(item=>{
      const file = (item.file || "").trim();
      if(!file) return;
      const opt = document.createElement("option");
      // Eğer tam URL değilse, Metinler klasörünün altı kabul edilir
      opt.value = file.startsWith("http") ? file : (METINLER_BASE_URL + file);
      opt.textContent = item.label || file;
      readyTextSelect.appendChild(opt);
    });
  }catch(e){
    // list.json yoksa: birkaç örnek option, doğrudan Metinler klasörüne göre
    if(readyTextSelect.options.length === 1){
      const samples = [
        "Dikkatsizlik.txt",
        "139-Frig_Kralı.txt"
      ];
      samples.forEach(f=>{
        const opt = document.createElement("option");
        opt.value = METINLER_BASE_URL + f;
        opt.textContent = f.replace(/\.txt$/,"");
        readyTextSelect.appendChild(opt);
      });
    }
  }
}
loadReadyList();

/* TXT formatı:
   (1) Metin kısmı
   (2) Yeni satır
   ===SORULAR===
   (3) JSON: { "questions":[ ... ] }
*/
async function loadReadyTextFromTxt(url){
  if(readyStatus){
    readyStatus.textContent = "";
    readyStatus.style.color = "black";
  }

  if(!url){
    if(readyStatus){
      readyStatus.textContent = "Lütfen bir hazır metin seçin.";
      readyStatus.style.color = "red";
    }
    return;
  }

  // Eğer değer tam URL değilse, Metinler klasörü altı kabul edilir
  if(!/^https?:\/\//i.test(url)){
    url = METINLER_BASE_URL + url;
  }

  if(readyStatus){
    readyStatus.textContent = "Hazır metin yükleniyor...";
    readyStatus.style.color = "blue";
  }

  try{
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("TXT yüklenemedi. HTTP " + res.status);

    const txt = await res.text();
    const parts = txt.split(/\n===SORULAR===\n/);

    const onlyText = (parts[0] || "").trim();
    if(!onlyText) throw new Error("TXT içinde metin boş görünüyor.");

    // state reset
    stop();
    textDisplay.innerHTML = "";
    questionContainer.innerHTML = "";
    quizStatsPanel.innerHTML = "Test sonucu yok.";
    finishBtn.style.display = "none";
    finishBtn.disabled = false;

    quizPhase = "reading";
    questionsGenerated = false;
    currentQuestions = null;
    userAnswers = [];

    rawText = onlyText;
    loadText(rawText);
    calculateWordStats();
    generateStatus.innerText = "✅ Metin hazır.";

    // Sorular varsa yükle
    if(parts.length > 1){
      const jsonPart = (parts[1] || "").trim();
      if(jsonPart){
        const obj = JSON.parse(jsonPart);
        currentQuestions = obj.questions || [];
        userAnswers = new Array(currentQuestions.length).fill(null);

        currentQuestions.forEach(q=>{
          if(Array.isArray(q.options)){
            q.options = q.options.map(t => t.replace(/^[A-E]\)\s*/i,"").trim());
          }
        });
        currentQuestions.forEach(q => shuffleOptionsAndFixAnswer(q));

        if(readyStatus){
          readyStatus.textContent = "✅ Hazır metin ve sorular yüklendi.";
          readyStatus.style.color = "green";
        }
      }else{
        if(readyStatus){
          readyStatus.textContent = "✅ Hazır metin yüklendi. (Sorular eklenmemiş)";
          readyStatus.style.color = "green";
        }
      }
    }else{
      if(readyStatus){
        readyStatus.textContent = "✅ Hazır metin yüklendi. (Sorular eklenmemiş)";
        readyStatus.style.color = "green";
      }
    }
  }catch(err){
    console.error(err);
    if(readyStatus){
      readyStatus.textContent = "❌ " + (err.message || err);
      readyStatus.style.color = "red";
    }
  }
}

if(loadReadyBtn){
  loadReadyBtn.addEventListener("click", ()=>{
    loadReadyTextFromTxt(readyTextSelect.value);
  });
}

/* ========= RATE LIMIT / KİLİT / RETRY ========= */

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function extractRetrySecondsFromMessage(msg){
  const m = String(msg || "");
  const hh = /(\d+)h/.exec(m);
  const mm = /(\d+)m/.exec(m);
  const ss = /(\d+)s/.exec(m);
  const h = hh ? parseInt(hh[1],10) : 0;
  const mi = mm ? parseInt(mm[1],10) : 0;
  const s = ss ? parseInt(ss[1],10) : 0;
  const total = h*3600 + mi*60 + s;
  return total > 0 ? total : null;
}

async function openaiChatCompletionWithRetry(payload, apiKey, maxRetries){
  let attempt = 0;
  while(true){
    attempt++;

    const res = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + apiKey
      },
      body:JSON.stringify(payload)
    });

    const data = await res.json().catch(()=> ({}));

    if(res.ok) return data;

    const msg = data?.error?.message || ("HTTP " + res.status);

    if(res.status === 429 && attempt <= (maxRetries + 1)){
      const retrySec = extractRetrySecondsFromMessage(msg);
      if(retrySec && retrySec > 120){
        // saatlik blok gibi; otomatik bekletmeyelim
        throw new Error(msg);
      }
      const waitMs = retrySec ? retrySec*1000 : (15000 + (attempt-1)*10000);
      await sleep(waitMs);
      continue;
    }

    throw new Error(msg);
  }
}

/* ========= YAŞ + ZORLUK İÇİN YARDIMCI KURALLAR ========= */

function getTextLevelRules(ageGroup, level){
  let base = "";
  switch(ageGroup){
    case "7-9":
      base =
`- Dil ilkokul 2-3. sınıf düzeyinde sade ve anlaşılır olsun.
- Kısa ve basit cümleler kullan, karmaşık yan cümleciklerden kaçın.
- Somut örnekler ver; soyut kavram gerekiyorsa kısaca açıkla.`;
      break;
    case "10-12":
      base =
`- Dil ilkokul 4 ve ortaokul 1. sınıf düzeyinde olsun.
- Orta uzunlukta cümleler kullan; çok karmaşık yapılar kurma.
- Yeni kavramları basit tanımlarla açıkla.`;
      break;
    case "13-15":
      base =
`- Dil ortaokul 2-3. sınıf düzeyinde olsun.
- Orta–uzun cümleler kullanabilirsin.
- Soyut kavramları kullanırken kısa açıklamalar ekle.`;
      break;
    case "16-18":
      base =
`- Dil lise düzeyinde olsun.
- Daha uzun ve bağlantılı cümleler kullanabilirsin.
- Gerekli yerlerde terim kullan ama kısaca tanımla.`;
      break;
    case "18+":
      base =
`- Dil yetişkin/üniversite düzeyinde olabilir.
- Konuyu derinlemesine ve akıcı bir dille işle.
- Gerekli yerlerde teknik kavramlara yer verebilirsin.`;
      break;
    default:
      base =
`- Dil sade ve anlaşılır olsun.
- Cümleler çok karmaşık olmasın.`;
  }

  let levelRule = "";
  switch(level){
    case "kolay":
      levelRule =
`- Zorluk seviyesi KOLAY olsun: daha kısa cümleler, daha sık tekrarlar ve temel kavramlara odaklan.
- Çok fazla yeni kelime kullanma; kullanırsan hemen ardından kısa açıklama ekle.`;
      break;
    case "orta":
      levelRule =
`- Zorluk seviyesi ORTA olsun: cümle uzunlukları orta düzeyde olsun.
- Bazı yeni kelimeler ve kavramlar kullan; anlamları metin içinde anlaşılabilir olsun.`;
      break;
    case "zor":
      levelRule =
`- Zorluk seviyesi ZOR olsun: daha uzun ve bağlantılı cümleler kullan.
- Konuyu daha derinlemesine işle; gerektiğinde terimler kullan ama kısaca tanımla.`;
      break;
    default:
      levelRule = "";
  }

  return base + "\n" + levelRule;
}

function getQuestionLevelRules(ageGroup, level){
  let base = "";
  switch(ageGroup){
    case "7-9":
      base =
`- Sorular ilkokul 2-3. sınıf düzeyinde, kısa ve sade olsun.
- Soru kökleri çok uzun olmasın, tek bir fikir sorsun.`;
      break;
    case "10-12":
      base =
`- Sorular ilkokul 4 ve ortaokul 1. sınıf düzeyinde olsun.
- Hem detay hem ana fikir soruları içerebilir.`;
      break;
    case "13-15":
      base =
`- Sorular ortaokul düzeyinde olsun.
- Bazı sorular yorum gerektirebilir, ama metne dayalı kalsın.`;
      break;
    case "16-18":
      base =
`- Sorular lise düzeyinde olsun.
- Yorum ve çıkarım gerektiren sorulara da yer ver.`;
      break;
    case "18+":
      base =
`- Sorular yetişkin/üniversite düzeyinde olabilir.
- Yorum ve analiz gerektiren sorular sorabilirsin.`;
      break;
    default:
      base =
`- Sorular metne dayalı ve anlaşılır olsun.`;
  }

  let levelRule = "";
  switch(level){
    case "kolay":
      levelRule =
`- Zorluk seviyesi KOLAY olsun: daha çok doğrudan metinde geçen bilgiyi sorsun.
- Çeldirici şıklar çok karmaşık olmasın.`;
      break;
    case "orta":
      levelRule =
`- Zorluk seviyesi ORTA olsun: hem doğrudan bilgi hem de basit çıkarım soruları içersin.
- Çeldiriciler mantıklı ama ayırt edilebilir olsun.`;
      break;
    case "zor":
      levelRule =
`- Zorluk seviyesi ZOR olsun: detay ve yorum soruları daha fazla olsun.
- Çeldiriciler metne kısmen dayalı, dikkat gerektiren türden olsun.`;
      break;
    default:
      levelRule = "";
  }

  return base + "\n" + levelRule;
}

/* ========= METİN OLUŞTURMA (ChatGPT) ========= */

const ageGroupInput   = document.getElementById("ageGroupInput");
const levelInput      = document.getElementById("levelInput");
const topicInput      = document.getElementById("topicInput");
const generateTextBtn = document.getElementById("generateTextBtn");
const generateStatus  = document.getElementById("generateStatus");
const textDisplay     = document.getElementById("textDisplay");

generateTextBtn.onclick = generateTextFromAPI;

let words = [];
let currentIndex = 0;
let timeoutId = null;
let paused = false;
let rawText = "";
let quizPhase = "reading";        // "reading" -> "questions" -> "finished"
let currentQuestions = null;
let userAnswers = [];
let questionsGenerated = false;

let isBusyGenerating = false;

async function generateTextFromAPI(){
  if(isBusyGenerating) return;

  if(srcReady && srcReady.checked){
    alert("Hazır metin modunda 'Hazır Metni Yükle' butonunu kullanın.");
    return;
  }

  const apiKey = getApiKey();
  updateApiStatusLine();

  if(!apiKey){
    alert("API anahtarı kayıtlı değil. Bu sayfadan API anahtarını doğrulayın ve kaydedin.");
    return;
  }

  const ageGroup = ageGroupInput.value;
  const level    = levelInput.value;
  const topic    = topicInput.value.trim();

  if(!ageGroup || !level || !topic){
    alert("Yaş aralığı, zorluk seviyesi ve konu giriniz.");
    return;
  }

  stop();
  textDisplay.innerHTML = "";
  questionContainer.innerHTML = "";
  quizStatsPanel.innerHTML = "Test sonucu yok.";
  generateStatus.innerText = "Metin oluşturuluyor...";

  isBusyGenerating = true;
  if(generateTextBtn){
    generateTextBtn.disabled = true;
    generateTextBtn.textContent = "Lütfen bekleyin...";
  }

  // quiz state reset
  quizPhase = "reading";
  questionsGenerated = false;
  currentQuestions = null;
  userAnswers = [];
  finishBtn.style.display = "none";
  finishBtn.disabled = false;

  const levelRules = getTextLevelRules(ageGroup, level);

  const prompt = `
${ageGroup} yaş aralığındaki bir öğrenci için, "${topic}" konusunda Türkçe bir öğretici metin yaz.

Genel kurallar:
- Yaklaşık 400–500 kelime olsun.
- Başlık mutlaka olsun.
- Markdown formatı kullanma.
- Liste, madde imi, kod bloğu kullanma.
- BAŞLIKTA VE METİNDE ASLA '#' KARAKTERİ KULLANMA.
- Metin normal paragraf yapısında olsun.

Yaş ve zorluk kuralları:
${levelRules}

En sonda kısa bir kapanış cümlesi yaz.
`;

  try{
    const data = await openaiChatCompletionWithRetry({
      model:"gpt-4o-mini",
      messages:[{role:"user",content:prompt}],
      max_tokens:900,
      temperature:0.8
    }, apiKey, 2);

    let raw = data?.choices?.[0]?.message?.content || "";
    raw = raw.replace(/^#+\s*/gm,"").trim();

    if(!raw){
      throw new Error("API yanıtı boş döndü (metin üretilemedi).");
    }

    rawText = raw;
    loadText(rawText);

    if(!words || words.length === 0){
      throw new Error("Metin işlendi ama kelimeler oluşturulamadı.");
    }

    calculateWordStats();
    generateStatus.innerText = "✅ Metin hazır.";
  }catch(err){
    console.error(err);
    generateStatus.innerText = "❌ Metin oluşturulamadı.";
    alert("Metin üretilemedi:\n" + (err?.message || err));
  }finally{
    isBusyGenerating = false;
    if(generateTextBtn){
      generateTextBtn.disabled = false;
      generateTextBtn.textContent = "Metin Oluştur";
    }
  }
}

/* ========= BLOK OKUMA VERİ YAPISI ========= */

function loadText(txt){
  textDisplay.innerHTML = "";
  words = [];
  currentIndex = 0;

  txt.split(/\r?\n\s*\r?\n|[\r\n]+/).forEach(line=>{
    const div = document.createElement("div");
    div.className = "line";
    const lineWords = line.trim().split(/\s+/);
    lineWords.forEach((w,i)=>{
      if(!w) return;
      const span = document.createElement("span");
      span.textContent = w + " ";
      span.className   = "hiddenWord";
      span.dataset.isParagraphStart = (i === 0);
      span.dataset.isSentenceEnd    = /[.!?,;…]$/.test(w);
      words.push(span);
      div.appendChild(span);
    });
    textDisplay.appendChild(div);
  });
}

/* ========= İSTATİSTİK HESAPLAMA ========= */

const timeInput       = document.getElementById("timeInput");
const blockCountInput = document.getElementById("blockCountInput");
const wordStats       = document.getElementById("wordStats");
const quizStatsPanel  = document.getElementById("quizStatsPanel");

timeInput.addEventListener("input", calculateWordStats);
blockCountInput.addEventListener("input", calculateWordStats);

function calculateWordStats(){
  if(!rawText) return;
  const arr = rawText
    .replace(/[^\wğüşöçıİĞÜŞÖÇ]/g," ")
    .split(/\s+/)
    .filter(Boolean);

  const total = arr.length;
  if(total === 0) return;

  const chars = arr.reduce((s,w)=>s + w.length, 0);
  const avg   = (chars / total).toFixed(2);

  const X     = +timeInput.value || 300;
  const block = +blockCountInput.value || 1;

  let totalTime = 0;
  arr.forEach(w=>{
    let t = X - ((5 - w.length) * X / 10) * 1.2;
    if(t < 1) t = 1;
    totalTime += t;
  });

  const wpm = Math.round(60000 / (totalTime / total / block));
  wordStats.innerHTML =
    `Toplam: ${total}<br>` +
    `Ortalama: ${avg}<br>` +
    `Hız: ${wpm} dk`;
}

/* ========= BLOK SİSTEMİ (SATIR SONU DA BLOK SINIRI) ========= */

function showNextWord(){
  if(paused) return;

  if(currentIndex >= words.length){
    if(!questionsGenerated && quizPhase === "reading"){
      questionsGenerated = true;
      quizPhase = "questions";
      setTimeout(async ()=>{
        if(currentQuestions && currentQuestions.length){
          renderQuestions();
          finishBtn.style.display = "inline-block";
          finishBtn.disabled = false;
          return;
        }
        await generateQuestionsForText();
        renderQuestions();
        if(currentQuestions && currentQuestions.length){
          finishBtn.style.display = "inline-block";
          finishBtn.disabled = false;
        }
      }, 300);
    }
    return;
  }

  words.forEach(w=>w.className="hiddenWord");

  let blockCount = Math.min(3, parseInt(blockCountInput.value,10) || 1);
  const blockWords = [];
  let displayed = 0;

  let first = words[currentIndex];
  first.className = "visibleWord";
  blockWords.push(first);
  displayed = 1;

  for(let i=1; i<blockCount; i++){
    if(currentIndex + i >= words.length) break;

    const prev = words[currentIndex + i - 1];
    const next = words[currentIndex + i];

    const sentenceEnd   = prev.dataset.isSentenceEnd === "true";
    const paragraphStart= next.dataset.isParagraphStart === "true";
    const sameLine      = prev.offsetTop === next.offsetTop;

    if(sentenceEnd || paragraphStart || !sameLine) break;

    next.className = "visibleWord";
    blockWords.push(next);
    displayed++;
  }

  const X = +timeInput.value || 300;
  let total = 0;
  blockWords.forEach(w=>{
    const len = w.textContent.trim().length;
    let t = X - ((5 - len) * X / 10) * 1.2;
    if(t < 1) t = 1;
    total += t;
  });
  const time = total / blockWords.length;

  currentIndex += displayed;

  timeoutId = setTimeout(()=>{
    blockWords.forEach(w=>w.className="hiddenWord");
    showNextWord();
  }, time);
}

/* ========= OKUMA BUTONLARI ========= */

const startBtn = document.getElementById("startBtn");
const pauseBtn = document.getElementById("pauseBtn");
const stopBtn  = document.getElementById("stopBtn");

function start(){
  if(!words.length){
    alert("Önce metin oluşturun veya hazır metin seçin.");
    return;
  }
  paused = false;
  showNextWord();
}
function pause(){
  paused = true;
  clearTimeout(timeoutId);
}
function stop(){
  paused = false;
  clearTimeout(timeoutId);
  currentIndex = 0;
  words.forEach(w=>w.className="hiddenWord");
}

startBtn.onclick = start;
pauseBtn.onclick = pause;
stopBtn.onclick  = stop;

/* ========= SORU SİSTEMİ ========= */

const finishBtn         = document.getElementById("finishBtn");
const questionContainer = document.getElementById("questionContainer");

finishBtn.addEventListener("click", ()=>{
  if(quizPhase !== "questions") return;
  evaluateQuiz();
  quizPhase = "finished";
  finishBtn.disabled = true;
});

/* ======== ŞIKLARI KARIŞTIR + DOĞRU CEVABI GÜNCELLE ======== */
const ANSWER_LETTERS = ["A","B","C","D","E"];

function shuffleOptionsAndFixAnswer(q){
  const answerLetter = (q.answer || "").toString().trim().toUpperCase();
  const correctIdx = ANSWER_LETTERS.indexOf(answerLetter);

  if(correctIdx < 0) return;
  if(!Array.isArray(q.options) || q.options.length !== 5) return;

  // (metin + eski index)
  const packed = q.options.map((t, i) => ({ t, i }));

  // Fisher–Yates shuffle
  for(let i = packed.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [packed[i], packed[j]] = [packed[j], packed[i]];
  }

  // yeni options
  q.options = packed.map(x => x.t);

  // doğru cevabın yeni konumu
  const newCorrectPos = packed.findIndex(x => x.i === correctIdx);
  q.answer = ANSWER_LETTERS[newCorrectPos];
}
/* ==================================================================== */

let isBusyQuestions = false;

async function generateQuestionsForText(){
  if(isBusyQuestions) return;

  const apiKey = getApiKey();
  updateApiStatusLine();

  if(!apiKey){
    alert("API anahtarı kayıtlı değil. Bu sayfadan API anahtarını doğrulayın ve kaydedin.");
    questionContainer.innerHTML = "";
    return;
  }

  if(!rawText){
    questionContainer.innerHTML = "";
    return;
  }

  if(currentQuestions && currentQuestions.length){
    return;
  }

  isBusyQuestions = true;
  questionContainer.innerHTML = "Sorular hazırlanıyor...";

  const ageGroup = ageGroupInput.value;
  const level    = levelInput.value;
  const levelRules = getQuestionLevelRules(ageGroup, level);

  const prompt = `
${ageGroup || "belirsiz"} yaş aralığındaki bir öğrenci için, aşağıdaki metne göre Türkçe 10 adet okuduğunu anlama sorusu hazırla.

Genel kurallar:
- Her soru için A, B, C, D ve E şıkları olsun.
- Şıklar kısa ve net olsun.
- Cevaplar sadece metne dayalı olsun.
- Doğru şık harfleri mümkün olduğunca eşit dağılmış olsun; 10 soruda her harf (A,B,C,D,E) tercihen 2 kere doğru cevap olsun.

Yaş ve zorluk kuralları:
${levelRules}

Çıkış kesinlikle sadece JSON olsun, JSON dışında açıklama yazma.

Metin:
"""${rawText}"""

JSON formatı tam olarak şöyle olsun:
{
  "questions": [
    {
      "q": "Soru metni",
      "options": ["A) ...","B) ...","C) ...","D) ...","E) ..."],
      "answer": "C"
    }
  ]
}
`;

  try{
    const data = await openaiChatCompletionWithRetry({
      model:"gpt-4o-mini",
      messages:[{role:"user",content:prompt}],
      max_tokens:1200,
      temperature:0.7
    }, apiKey, 2);

    let text = data?.choices?.[0]?.message?.content || "";
    const idx = text.indexOf("{");
    if(idx > 0) text = text.slice(idx);

    const obj = JSON.parse(text);
    currentQuestions = obj.questions || [];
    userAnswers = new Array(currentQuestions.length).fill(null);

    // Şıkları A)/B) etiketlerinden temizle
    currentQuestions.forEach(q=>{
      if(Array.isArray(q.options)){
        q.options = q.options.map(t =>
          t.replace(/^[A-E]\)\s*/i,"").trim()
        );
      }
    });

    // Şıkları karıştır ve doğru cevabı da yeni konuma göre güncelle
    currentQuestions.forEach(q => shuffleOptionsAndFixAnswer(q));

  }catch(err){
    console.error(err);
    alert("Sorular oluşturulurken hata oluştu: " + (err?.message || err));
    questionContainer.innerHTML = "Sorular yüklenemedi.";
  }finally{
    isBusyQuestions = false;
  }
}

function renderQuestions(){
  questionContainer.innerHTML = "";
  if(!currentQuestions || !currentQuestions.length){
    questionContainer.innerHTML = "Gösterilecek soru bulunamadı.";
    return;
  }

  const letters = ["A","B","C","D","E"];

  currentQuestions.forEach((qObj, qi)=>{
    const qDiv = document.createElement("div");
    qDiv.className = "question";

    const p = document.createElement("p");
    p.textContent = (qi+1) + ") " + (qObj.q || "");
    qDiv.appendChild(p);

    const optsDiv = document.createElement("div");
    optsDiv.className = "options";

    (qObj.options || []).forEach((optText, oi)=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "optionBtn";
      btn.textContent = letters[oi] + ") " + optText;
      btn.dataset.questionIndex = qi;
      btn.dataset.optionIndex   = oi;

      btn.addEventListener("click", ()=>{
        const siblings = optsDiv.querySelectorAll(".optionBtn");
        siblings.forEach(s=>s.classList.remove("selected"));
        btn.classList.add("selected");
        userAnswers[qi] = oi;
      });

      optsDiv.appendChild(btn);
    });

    qDiv.appendChild(optsDiv);
    questionContainer.appendChild(qDiv);
  });
}

function evaluateQuiz(){
  if(!currentQuestions || !currentQuestions.length) return;

  const letters = ["A","B","C","D","E"];
  let correctCount = 0;
  let wrongCount   = 0;

  const questionDivs = questionContainer.querySelectorAll(".question");

  currentQuestions.forEach((qObj, qi)=>{
    const answerLetter = (qObj.answer || "").toString().trim().toUpperCase();
    const correctIdx   = letters.indexOf(answerLetter);
    const qDiv         = questionDivs[qi];
    if(!qDiv) return;

    const buttons = qDiv.querySelectorAll(".optionBtn");
    buttons.forEach((btn, oi)=>{
      btn.classList.remove("correct","wrong","selected");
      if(oi === correctIdx){
        btn.classList.add("correct");
      }
    });

    const userIdx = userAnswers[qi];
    if(userIdx === null || userIdx === undefined){
      wrongCount++;
    }else{
      if(userIdx === correctIdx){
        correctCount++;
      }else{
        wrongCount++;
        const wrongBtn = buttons[userIdx];
        if(wrongBtn) wrongBtn.classList.add("wrong");
      }
    }
  });

  quizStatsPanel.innerHTML =
    `Doğru: ${correctCount}<br>` +
    `Yanlış: ${wrongCount}`;
}
</script>

</body>
</html>
