<!-- Uygulamalar/blok.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Blok Okuma + ChatGPT Metin Ãœretme</title>
<style>
body{
  font-family:Arial,sans-serif;
  margin:0;
  padding:0;
  height:100vh;
}
#container{
  display:flex;
  height:100vh;
}

/* SOL PANEL */
#settings{
  width:260px;
  background:#f0f0f0;
  border-right:1px solid #ccc;
  display:flex;
  flex-direction:column;
  height:100vh;
}
#settingsContent{
  flex:1;
  overflow-y:auto;
  padding:15px;
}
#wordStats{
  background:#e8e8e8;
  padding:8px;
  font-size:12px;
  border-top:1px solid #ccc;
}
#quizStatsPanel{
  background:#e8e8e8;
  padding:8px;
  font-size:12px;
  border-top:1px solid #ccc;
}
.section{
  margin-bottom:12px;
  padding-bottom:8px;
  border-bottom:1px solid #ccc;
}
#settings label,
#settings input,
#settings select,
#settings button{
  width:100%;
  margin-bottom:6px;
  font-size:12px;
  box-sizing:border-box;
}
#settings h3{
  margin:0 0 6px;
  font-size:14px;
}
#settings button{
  padding:6px;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.primary{background:#007bff;color:white}
.secondary{background:#6c757d;color:white}

/* Radyo/checkbox geniÅŸlik dÃ¼zeltmesi */
#settings input[type="radio"],
#settings input[type="checkbox"]{
  width:auto !important;
  display:inline-block !important;
  margin:0 6px 0 0 !important;
}

/* Radyo satÄ±rlarÄ± sola hizalÄ± */
.textModeRow{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:4px;
  margin-bottom:8px;
}
.radioRow{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
}

/* SAÄ PANEL (METÄ°N + SORULAR) */
#rightPanel{
  flex:1;
  display:flex;
  flex-direction:column;
  background:white;
}

/* METÄ°N ALANI */
#textDisplay{
  flex:1;
  padding:20px;
  font-family:monospace;
  font-size:20px;
  background:white;
  overflow-y:auto;
  white-space:pre-wrap;
  line-height:1.6;
}
.hiddenWord{color:#f5f5f5}
.visibleWord{color:black}
.line{display:block}

/* SORU ALANI */
#questionContainer{
  padding:10px 20px 10px 20px;
  overflow-y:auto;
}
.question{
  margin-bottom:15px;
}
.question p{
  margin:0 0 6px 0;
}
.options{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.optionBtn{
  text-align:left;
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:4px;
  background:#f8f8f8;
  cursor:pointer;
  font-size:14px;
}
.optionBtn.selected{
  border-color:#007bff;
  background:#e6f0ff;
}
.optionBtn.correct{
  background:#c9f7c2 !important;
  border-color:#28a745 !important;
}
.optionBtn.wrong{
  background:#f8d7da !important;
  border-color:#dc3545 !important;
}

/* BUTONLAR (OKUMAYI BAÅLAT + OKUMA BÄ°TTÄ° + TESTÄ° BÄ°TÄ°R) */
#readingDoneBtn,
#finishBtn{
  margin:0 20px 10px 20px;
  padding:8px 12px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:14px;
  align-self:flex-start;
  display:none; /* baÅŸta gizli */
}
#readingDoneBtn{
  background:#17a2b8;
  color:white;
}
#finishBtn{
  background:#28a745;
  color:white;
}
#freeStartBtn{
  margin-top:6px;
}
</style>
</head>

<body>

<div id="container">

  <div id="settings">

    <div id="settingsContent">

      <!-- API BÃ–LÃœMÃœ -->
      <div class="section">
        <h3>1) API Durumu</h3>
        <div id="apiStatusLine" style="font-weight:bold;margin-bottom:6px;"></div>

        <!-- âœ… Yeni: API kodu deÄŸiÅŸtir -->
        <button class="secondary" id="apiChangeBtn" type="button" style="display:none;margin-bottom:6px;">
          API kodu deÄŸiÅŸtir
        </button>

        <div id="apiEntry" style="display:none;">
          <input id="apiKeyInput" type="password" placeholder="OpenAI API anahtarÄ± (sk-...)" style="width:100%;margin-bottom:6px;box-sizing:border-box;">
          <button class="primary" id="apiSaveBtn" type="button">API DoÄŸrula ve Kaydet</button>
          <div id="apiSaveStatus" style="font-size:11px;margin-top:6px;"></div>
        </div>
      </div>

      <!-- METÄ°N BÃ–LÃœMÃœ -->
      <div class="section">
        <h3>2) Metin</h3>

        <!-- Ana iki seÃ§enek -->
        <div class="textModeRow">
          <div class="radioRow">
            <input type="radio" name="textMode" value="ai" checked>
            <span>Yapay zeka ile metin oluÅŸtur</span>
          </div>
          <div class="radioRow">
            <input type="radio" name="textMode" value="ready">
            <span>HazÄ±r metin seÃ§</span>
          </div>
        </div>

        <!-- 1) Yapay zeka ile metin oluÅŸtur -->
        <div id="aiOptions">
          <label>YaÅŸ AralÄ±ÄŸÄ±</label>
          <select id="ageGroupInput">
            <option value="">SeÃ§iniz</option>
            <option value="7-9">7-9</option>
            <option value="10-12">10-12</option>
            <option value="13-15">13-15</option>
            <option value="16-18">16-18</option>
            <option value="18+">18+</option>
          </select>

          <label>Zorluk Seviyesi</label>
          <select id="levelInput">
            <option value="">SeÃ§iniz</option>
            <option value="kolay">Kolay</option>
            <option value="orta">Orta</option>
            <option value="zor">Zor</option>
          </select>

          <label>Konu</label>
          <input type="text" id="topicInput" placeholder="Ã–rn: GÃ¼neÅŸ Sistemi">
        </div>

        <!-- 2) HazÄ±r metin seÃ§ -->
        <div id="readyOptions" style="display:none;">
          <label>HazÄ±r metin seÃ§iniz</label>
          <select id="readyTextSelect">
            <option value="">SeÃ§iniz</option>
          </select>
        </div>

        <!-- Ortak buton -->
        <button class="primary" id="generateTextBtn" type="button">Metin OluÅŸtur</button>
        <div id="generateStatus" style="font-size:11px;margin-top:4px;"></div>
      </div>

      <!-- OKUMA BÃ–LÃœMÃœ -->
      <div class="section">
        <h3>3) Okuma</h3>

        <!-- Okuma modu: HÄ±z belirle / Serbest okuma -->
        <div class="textModeRow">
          <div class="radioRow">
            <input type="radio" name="readMode" value="speed" checked>
            <span>HÄ±z belirle</span>
          </div>
          <div class="radioRow">
            <input type="radio" name="readMode" value="free">
            <span>Serbest okuma</span>
          </div>
        </div>

        <!-- Serbest okuma: OkumayÄ± BaÅŸlat -->
        <button class="primary" id="freeStartBtn" type="button" style="display:none;">OkumayÄ± BaÅŸlat</button>

        <!-- HÄ±z belirleme seÃ§enekleri -->
        <div id="speedOptions">
          <label>SÃ¼re (ms) â€“ 5 harf</label>
          <input type="number" id="timeInput" value="300" step="50" min="50">
          <label>Blok (en fazla 3)</label>
          <select id="blockCountInput">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
          <button class="primary" id="startBtn" type="button">BaÅŸlat</button>
          <button class="secondary" id="pauseBtn" type="button">Duraklat</button>
          <button class="secondary" id="stopBtn" type="button">Durdur</button>
        </div>
      </div>

    </div>

    <div id="wordStats">
      Toplam: 0<br>
      HÄ±z: 0 kelime/dk (0 ms/kelime)<br>
      SÃ¼re: 0 sn
    </div>
    <div id="quizStatsPanel">
      Test sonucu yok.
    </div>

  </div>

  <!-- SAÄ PANEL: METÄ°N + SORULAR -->
  <div id="rightPanel">
    <div id="textDisplay"></div>
    <button id="readingDoneBtn" type="button">Okuma Bitti</button>
    <button id="finishBtn" type="button">Testi Bitir</button>
    <div id="questionContainer"></div>
  </div>

</div>

<script>
/* ========= KULLANICI KODU GÃœVENLÄ°K KONTROLÃœ ========= */
(function ensureUserCode(){
  const code = localStorage.getItem("USER_CODE");
  if(!code || !code.trim()){
    alert("Ã–nce kullanÄ±cÄ± kodu ile giriÅŸ yapmalÄ±sÄ±nÄ±z.");
    window.location.href = "AnaSayfa.html";
  }
})();

/* ========= HIZ SATIRI FORMAT (kelime/dk + ms/kelime) ========= */
function formatSpeedLine(wpm){
  const safeWpm = Math.max(0, parseInt(wpm, 10) || 0);
  const msPerWord = safeWpm > 0 ? Math.round(60000 / safeWpm) : 0;
  return `HÄ±z: ${safeWpm} kelime/dk (${msPerWord} ms/kelime)`;
}

/* ========= API ANAHTARI DURUMU ========= */
function getApiKey(){
  return localStorage.getItem("USER_API_KEY") || "";
}

const apiStatusLine = document.getElementById("apiStatusLine");
const apiEntry      = document.getElementById("apiEntry");
const apiKeyInput   = document.getElementById("apiKeyInput");
const apiSaveBtn    = document.getElementById("apiSaveBtn");
const apiSaveStatus = document.getElementById("apiSaveStatus");

/* âœ… Yeni: DeÄŸiÅŸtir butonu + edit modu */
const apiChangeBtn  = document.getElementById("apiChangeBtn");
let apiEditMode = false;

function setApiEditMode(on){
  apiEditMode = !!on;

  if(apiEditMode){
    // dÃ¼zenleme modu: giriÅŸ alanÄ±nÄ± aÃ§
    if(apiEntry) apiEntry.style.display = "block";
    if(apiChangeBtn){
      apiChangeBtn.style.display = "block";
      apiChangeBtn.textContent = "Ä°ptal";
    }
    if(apiSaveStatus){
      apiSaveStatus.textContent = "";
      apiSaveStatus.style.color = "black";
    }
    apiStatusLine.textContent = "ğŸ”„ API deÄŸiÅŸtiriliyor...";
    apiStatusLine.style.color = "orange";

    // Eski key'i input'a yazmak istemiyorsan aÅŸaÄŸÄ±daki 2 satÄ±rÄ± silebilirsin:
    const key = getApiKey();
    if(apiKeyInput && key) apiKeyInput.value = key;

    // Ä°stersen daha gÃ¼venli: input boÅŸ gelsin:
    // if(apiKeyInput) apiKeyInput.value = "";

    if(apiKeyInput) apiKeyInput.focus();
  }else{
    updateApiStatusLine(); // normal moda dÃ¶n
  }
}

if(apiChangeBtn){
  apiChangeBtn.addEventListener("click", ()=>{
    setApiEditMode(!apiEditMode);
  });
}

async function verifyApiKey(key){
  const res = await fetch("https://api.openai.com/v1/models", {
    headers: { "Authorization": "Bearer " + key }
  });
  return res.ok;
}

async function handleApiSave(){
  const key = (apiKeyInput.value || "").trim();
  if(apiSaveStatus){
    apiSaveStatus.textContent = "";
    apiSaveStatus.style.color = "black";
  }

  if(!key || key.length < 10){
    apiSaveStatus.textContent = "LÃ¼tfen geÃ§erli bir anahtar girin.";
    apiSaveStatus.style.color = "red";
    return;
  }

  apiSaveBtn.disabled = true;
  apiSaveStatus.textContent = "API kontrol ediliyor...";
  apiSaveStatus.style.color = "blue";

  try{
    const ok = await verifyApiKey(key);
    if(ok){
      localStorage.setItem("USER_API_KEY", key);
      apiSaveStatus.textContent = "âœ… API geÃ§erli ve kaydedildi.";
      apiSaveStatus.style.color = "green";

      // âœ… Kaydedince edit modundan Ã§Ä±k
      apiEditMode = false;
      updateApiStatusLine();
    }else{
      localStorage.removeItem("USER_API_KEY");
      apiSaveStatus.textContent = "âŒ API geÃ§ersiz. LÃ¼tfen tekrar deneyin.";
      apiSaveStatus.style.color = "red";

      apiEditMode = false;
      updateApiStatusLine();
    }
  }catch(err){
    console.error(err);
    apiSaveStatus.textContent = "âš  BaÄŸlantÄ± hatasÄ±. LÃ¼tfen tekrar deneyin.";
    apiSaveStatus.style.color = "orange";
  }finally{
    apiSaveBtn.disabled = false;
  }
}

if(apiSaveBtn){
  apiSaveBtn.addEventListener("click", handleApiSave);
}

function updateApiStatusLine(){
  const key = getApiKey();

  // Edit modundayken otomatik ezme yapmayalÄ±m
  if(apiEditMode) return;

  if(key && key.trim().length > 10){
    apiStatusLine.textContent = "âœ… API kayÄ±tlÄ±";
    apiStatusLine.style.color = "green";

    // KayÄ±tlÄ±yken giriÅŸ alanÄ±nÄ± gizle, deÄŸiÅŸtir butonunu gÃ¶ster
    if(apiEntry) apiEntry.style.display = "none";
    if(apiChangeBtn){
      apiChangeBtn.style.display = "block";
      apiChangeBtn.textContent = "API kodu deÄŸiÅŸtir";
    }

    // Ä°stersen input'a yaz (maskeli)
    if(apiKeyInput) apiKeyInput.value = key;
  }else{
    apiStatusLine.textContent = "âŒ API kayÄ±tlÄ± deÄŸil";
    apiStatusLine.style.color = "red";

    // KayÄ±tlÄ± deÄŸilken giriÅŸ alanÄ± aÃ§Ä±k, deÄŸiÅŸtir butonu kapalÄ±
    if(apiEntry) apiEntry.style.display = "block";
    if(apiChangeBtn) apiChangeBtn.style.display = "none";
  }
}
updateApiStatusLine();

/* ========= YAÅ + ZORLUK KURALLARI ========= */
function getTextLevelRules(ageGroup, level){
  let base = "";
  switch(ageGroup){
    case "7-9":
      base =
`- Dil ilkokul 2-3. sÄ±nÄ±f dÃ¼zeyinde sade ve anlaÅŸÄ±lÄ±r olsun.
- KÄ±sa ve basit cÃ¼mleler kullan, karmaÅŸÄ±k yan cÃ¼mleciklerden kaÃ§Ä±n.
- Somut Ã¶rnekler ver; soyut kavram gerekiyorsa kÄ±saca aÃ§Ä±kla.`;
      break;
    case "10-12":
      base =
`- Dil ilkokul 4 ve ortaokul 1. sÄ±nÄ±f dÃ¼zeyinde olsun.
- Orta uzunlukta cÃ¼mleler kullan; Ã§ok karmaÅŸÄ±k yapÄ±lar kurma.
- Yeni kavramlarÄ± basit tanÄ±mlarla aÃ§Ä±kla.`;
      break;
    case "13-15":
      base =
`- Dil ortaokul 2-3. sÄ±nÄ±f dÃ¼zeyinde olsun.
- Ortaâ€“uzun cÃ¼mleler kullanabilirsin.
- Soyut kavramlarÄ± kullanÄ±rken kÄ±sa aÃ§Ä±klamalar ekle.`;
      break;
    case "16-18":
      base =
`- Dil lise dÃ¼zeyinde olsun.
- Daha uzun ve baÄŸlantÄ±lÄ± cÃ¼mleler kullanabilirsin.
- Gerekli yerlerde terim kullan ama kÄ±saca tanÄ±mla.`;
      break;
    case "18+":
      base =
`- Dil yetiÅŸkin/Ã¼niversite dÃ¼zeyinde olabilir.
- Konuyu derinlemesine ve akÄ±cÄ± bir dille iÅŸle.
- Gerekli yerlerde teknik kavramlara yer verebilirsin.`;
      break;
    default:
      base =
`- Dil sade ve anlaÅŸÄ±lÄ±r olsun.
- CÃ¼mleler Ã§ok karmaÅŸÄ±k olmasÄ±n.`;
  }

  let levelRule = "";
  switch(level){
    case "kolay":
      levelRule =
`- Zorluk seviyesi KOLAY olsun: daha kÄ±sa cÃ¼mleler, daha sÄ±k tekrarlar ve temel kavramlara odaklan.
- Ã‡ok fazla yeni kelime kullanma; kullanÄ±rsan hemen ardÄ±ndan kÄ±sa aÃ§Ä±klama ekle.`;
      break;
    case "orta":
      levelRule =
`- Zorluk seviyesi ORTA olsun: cÃ¼mle uzunluklarÄ± orta dÃ¼zeyde olsun.
- BazÄ± yeni kavramlar ve kelimeler kullan; anlamlarÄ± metin iÃ§inde anlaÅŸÄ±labilir olsun.`;
      break;
    case "zor":
      levelRule =
`- Zorluk seviyesi ZOR olsun: daha uzun ve baÄŸlantÄ±lÄ± cÃ¼mleler kullan.
- Konuyu daha derinlemesine iÅŸle; gerektiÄŸinde terimler kullan ama kÄ±saca tanÄ±mla.`;
      break;
    default:
      levelRule = "";
  }

  return base + "\n" + levelRule;
}

function getQuestionLevelRules(ageGroup, level){
  let base = "";
  switch(ageGroup){
    case "7-9":
      base =
`- Sorular ilkokul 2-3. sÄ±nÄ±f dÃ¼zeyinde, kÄ±sa ve sade olsun.
- Soru kÃ¶kleri Ã§ok uzun olmasÄ±n, tek bir fikir sorsun.`;
      break;
    case "10-12":
      base =
`- Sorular ilkokul 4 ve ortaokul 1. sÄ±nÄ±f dÃ¼zeyinde olsun.
- Hem detay hem ana fikir sorularÄ± iÃ§erebilir.`;
      break;
    case "13-15":
      base =
`- Sorular ortaokul dÃ¼zeyinde olsun.
- BazÄ± sorular yorum gerektirebilir, ama metne dayalÄ± kalsÄ±n.`;
      break;
    case "16-18":
      base =
`- Sorular lise dÃ¼zeyinde olsun.
- Yorum ve Ã§Ä±karÄ±m gerektiren sorulara da yer ver.`;
      break;
    case "18+":
      base =
`- Sorular yetiÅŸkin/Ã¼niversite dÃ¼zeyinde olabilir.
- Yorum ve analiz gerektiren sorular sorabilirsin.`;
      break;
    default:
      base =
`- Sorular metne dayalÄ± ve anlaÅŸÄ±lÄ±r olsun.`;
  }

  let levelRule = "";
  switch(level){
    case "kolay":
      levelRule =
`- Zorluk seviyesi KOLAY olsun: daha Ã§ok doÄŸrudan metinde geÃ§en bilgiyi sorsun.
- Ã‡eldirici ÅŸÄ±klar Ã§ok karmaÅŸÄ±k olmasÄ±n.`;
      break;
    case "orta":
      levelRule =
`- Zorluk seviyesi ORTA olsun: hem doÄŸrudan bilgi hem de basit Ã§Ä±karÄ±m sorularÄ± iÃ§ersin.
- Ã‡eldiriciler mantÄ±klÄ± ama ayÄ±rt edilebilir olsun.`;
      break;
    case "zor":
      levelRule =
`- Zorluk seviyesi ZOR olsun: detay ve yorum sorularÄ± daha fazla olsun.
- Ã‡eldiriciler metne kÄ±smen dayalÄ±, dikkat gerektiren tÃ¼rden olsun.`;
      break;
    default:
      levelRule = "";
  }

  return base + "\n" + levelRule;
}

/* ========= DOM & GLOBAL DURUM ========= */
const ageGroupInput   = document.getElementById("ageGroupInput");
const levelInput      = document.getElementById("levelInput");
const topicInput      = document.getElementById("topicInput");
const generateTextBtn = document.getElementById("generateTextBtn");
const generateStatus  = document.getElementById("generateStatus");
const textDisplay     = document.getElementById("textDisplay");

const modeRadios      = document.querySelectorAll('input[name="textMode"]');
const aiOptions       = document.getElementById("aiOptions");
const readyOptions    = document.getElementById("readyOptions");
const readyTextSelect = document.getElementById("readyTextSelect");

const timeInput       = document.getElementById("timeInput");
const blockCountInput = document.getElementById("blockCountInput");
const wordStats       = document.getElementById("wordStats");
const quizStatsPanel  = document.getElementById("quizStatsPanel");

const startBtn        = document.getElementById("startBtn");
const pauseBtn        = document.getElementById("pauseBtn");
const stopBtn         = document.getElementById("stopBtn");
const finishBtn       = document.getElementById("finishBtn");
const questionContainer = document.getElementById("questionContainer");

/* Okuma modu + serbest okuma butonu */
const readModeRadios  = document.querySelectorAll('input[name="readMode"]');
const speedOptions    = document.getElementById("speedOptions");
const readingDoneBtn  = document.getElementById("readingDoneBtn");
const freeStartBtn    = document.getElementById("freeStartBtn");

let currentReadMode   = "speed";

let words = [];
let currentIndex = 0;
let timeoutId = null;
let paused = false;
let rawText = "";
let quizPhase = "reading";
let currentQuestions = [];
let userAnswers = [];
let questionsGenerated = false;
let readyFileQuestions = [];

let freeReadingStart = null;
let freeTimerInterval = null;
let freeElapsedMs = 0;

let speedReadingStart = null;
let speedTimerInterval = null;
let speedElapsedMs = 0;
let speedBaseElapsedMs = 0;
let lastCalculatedWpm = 0;

const ANSWER_LETTERS = ["A","B","C","D","E"];

/* ========= HAZIR METÄ°NLERÄ° GÄ°THUB'DAN Ã‡EK ========= */
async function populateReadyTexts(){
  const select = readyTextSelect;
  if(!select) return;

  select.innerHTML = '<option value="">SeÃ§iniz</option>';

  const apiUrl = "https://api.github.com/repos/KronosEgitim/HizliOkuma/contents/Metinler";

  try{
    const res = await fetch(apiUrl);
    if(!res.ok){
      console.error("GitHub API hatasÄ±:", res.status, res.statusText);
      generateStatus.textContent = "HazÄ±r metin listesi alÄ±namadÄ± ("+res.status+").";
      generateStatus.style.color = "red";
      return;
    }

    const data = await res.json();

    const txtFiles = (data || [])
      .filter(item => item.type === "file" && item.name.toLowerCase().endsWith(".txt"));

    if(!txtFiles.length){
      generateStatus.textContent = "Metinler klasÃ¶rÃ¼nde .txt dosyasÄ± bulunamadÄ±.";
      generateStatus.style.color = "red";
      return;
    }

    txtFiles
      .sort((a,b)=>a.name.localeCompare(b.name,"tr"))
      .forEach(item=>{
        const opt = document.createElement("option");
        opt.value = item.download_url;
        opt.textContent = item.name.replace(/\.txt$/i,"");
        select.appendChild(opt);
      });

    generateStatus.textContent = "HazÄ±r metin listesi yÃ¼klendi.";
    generateStatus.style.color = "green";

  }catch(err){
    console.error("HazÄ±r metin listesi alÄ±namadÄ±:", err);
    generateStatus.textContent = "HazÄ±r metin listesi alÄ±namadÄ± (baÄŸlantÄ± hatasÄ±).";
    generateStatus.style.color = "red";
  }
}

/* ========= METÄ°N MODU (AI / HAZIR) ========= */
modeRadios.forEach(radio=>{
  radio.addEventListener("change", ()=>{
    const selected = document.querySelector('input[name="textMode"]:checked');
    const val = selected ? selected.value : "ai";
    if(val === "ai"){
      aiOptions.style.display = "block";
      readyOptions.style.display = "none";
    }else{
      aiOptions.style.display = "none";
      readyOptions.style.display = "block";
      populateReadyTexts();
    }
  });
});

(function initTextMode(){
  const selected = document.querySelector('input[name="textMode"]:checked');
  const val = selected ? selected.value : "ai";
  if(val === "ai"){
    aiOptions.style.display = "block";
    readyOptions.style.display = "none";
  }else{
    aiOptions.style.display = "none";
    readyOptions.style.display = "block";
  }
  populateReadyTexts();
})();

/* ========= TEMEL METÄ°N Ä°STATÄ°STÄ°K HESABI ========= */
function computeBasicTextStats(){
  if(!rawText) return null;
  const arr = rawText
    .replace(/[^\wÄŸÃ¼ÅŸÃ¶Ã§Ä±Ä°ÄÃœÅÃ–Ã‡]/g," ")
    .split(/\s+/)
    .filter(Boolean);

  const total = arr.length;
  if(total === 0) return null;

  const chars = arr.reduce((s,w)=>s + w.length, 0);
  const avg   = (chars / total).toFixed(2);

  return { total, chars, avg };
}

/* ========= SERBEST OKUMA SAYAÃ‡ FONKSÄ°YONLARI ========= */
function resetFreeTimer(){
  freeReadingStart = null;
  freeElapsedMs = 0;
  if(freeTimerInterval){
    clearInterval(freeTimerInterval);
    freeTimerInterval = null;
  }
}

function stopFreeTimerKeepElapsed(){
  if(freeTimerInterval){
    clearInterval(freeTimerInterval);
    freeTimerInterval = null;
  }
  freeReadingStart = null;
}

function updateFreeTimerDisplay(){
  const stats = computeBasicTextStats();
  const seconds = Math.floor(freeElapsedMs / 1000);
  if(!stats){
    wordStats.innerHTML =
      `Toplam: 0<br>` +
      `${formatSpeedLine(0)}<br>` +
      `SÃ¼re: ${seconds} sn`;
    return;
  }
  wordStats.innerHTML =
    `Toplam: ${stats.total}<br>` +
    `HÄ±z: -<br>` +
    `SÃ¼re: ${seconds} sn`;
}

function showFreeFinalStats(){
  const stats = computeBasicTextStats();
  if(!stats || freeElapsedMs <= 0){
    wordStats.innerHTML =
      `Toplam: ${stats ? stats.total : 0}<br>` +
      `${formatSpeedLine(0)}<br>` +
      `SÃ¼re: 0 sn`;
    return;
  }
  const seconds = Math.floor(freeElapsedMs / 1000);
  const minutes = freeElapsedMs / 60000;
  const wpm = Math.round(stats.total / minutes);

  wordStats.innerHTML =
    `Toplam: ${stats.total}<br>` +
    `${formatSpeedLine(wpm)}<br>` +
    `SÃ¼re: ${seconds} sn`;
}

/* ========= HIZ MODU SÃœRE SAYAÃ‡ FONKSÄ°YONLARI ========= */
function resetSpeedTimer(){
  speedReadingStart = null;
  speedElapsedMs = 0;
  speedBaseElapsedMs = 0;
  if(speedTimerInterval){
    clearInterval(speedTimerInterval);
    speedTimerInterval = null;
  }
}

function updateSpeedTimerDisplay(){
  const stats = computeBasicTextStats();
  const seconds = Math.floor(speedElapsedMs / 1000);
  if(!stats){
    wordStats.innerHTML =
      `Toplam: 0<br>` +
      `${formatSpeedLine(0)}<br>` +
      `SÃ¼re: ${seconds} sn`;
    return;
  }
  const wpm = lastCalculatedWpm || 0;
  wordStats.innerHTML =
    `Toplam: ${stats.total}<br>` +
    `${formatSpeedLine(wpm)}<br>` +
    `SÃ¼re: ${seconds} sn`;
}

function startSpeedTimer(){
  if(speedTimerInterval){
    clearInterval(speedTimerInterval);
    speedTimerInterval = null;
  }
  if(speedReadingStart === null){
    speedReadingStart = performance.now();
  }
  speedTimerInterval = setInterval(()=>{
    if(speedReadingStart != null){
      const now = performance.now();
      speedElapsedMs = speedBaseElapsedMs + (now - speedReadingStart);
      updateSpeedTimerDisplay();
    }
  }, 200);
}

function pauseSpeedTimer(){
  if(speedReadingStart != null){
    const now = performance.now();
    speedBaseElapsedMs += (now - speedReadingStart);
    speedReadingStart = null;
  }
  if(speedTimerInterval){
    clearInterval(speedTimerInterval);
    speedTimerInterval = null;
  }
  speedElapsedMs = speedBaseElapsedMs;
  updateSpeedTimerDisplay();
}

function finalizeSpeedTimer(){
  pauseSpeedTimer();
}

/* ========= OKUMA MODU (HIZ / SERBEST) ========= */
function revealAllWords(){
  words.forEach(w => w.className = "visibleWord");
}

function hideAllWords(){
  words.forEach(w => w.className = "hiddenWord");
}

function setReadModeUI(mode){
  currentReadMode = mode;
  resetSpeedTimer();

  if(mode === "speed"){
    speedOptions.style.display = "block";
    freeStartBtn.style.display = "none";
    readingDoneBtn.style.display = "none";

    paused = false;
    clearTimeout(timeoutId);
    currentIndex = 0;
    hideAllWords();
    resetFreeTimer();
    calculateWordStats();
  }else{
    speedOptions.style.display = "none";
    freeStartBtn.style.display = "inline-block";
    readingDoneBtn.style.display = "none";

    paused = false;
    clearTimeout(timeoutId);
    currentIndex = 0;
    hideAllWords();
    resetFreeTimer();

    const stats = computeBasicTextStats();
    if(stats){
      wordStats.innerHTML =
        `Toplam: ${stats.total}<br>` +
        `${formatSpeedLine(0)}<br>` +
        `SÃ¼re: 0 sn`;
    }else{
      wordStats.innerHTML =
        `Toplam: 0<br>` +
        `${formatSpeedLine(0)}<br>` +
        `SÃ¼re: 0 sn`;
    }
  }
}

readModeRadios.forEach(r=>{
  r.addEventListener("change", ()=>{
    const selected = document.querySelector('input[name="readMode"]:checked');
    setReadModeUI(selected ? selected.value : "speed");
  });
});

setReadModeUI("speed");

/* Serbest okuma: OkumayÄ± BaÅŸlat */
freeStartBtn.addEventListener("click", ()=>{
  if(currentReadMode !== "free") return;
  if(!rawText || !words.length){
    alert("Ã–nce metin oluÅŸturun veya hazÄ±r metin seÃ§in.");
    return;
  }
  revealAllWords();
  readingDoneBtn.style.display = "inline-block";

  resetFreeTimer();
  freeReadingStart = performance.now();
  freeTimerInterval = setInterval(()=>{
    if(freeReadingStart != null){
      freeElapsedMs = performance.now() - freeReadingStart;
      updateFreeTimerDisplay();
    }
  }, 200);
});

/* Ortak "Metin OluÅŸtur" */
generateTextBtn.onclick = async function(){
  const selected = document.querySelector('input[name="textMode"]:checked');
  const selectedMode = selected ? selected.value : "ai";
  if(selectedMode === "ai"){
    await generateTextFromAPI();
  }else{
    await loadReadyText();
  }
};

/* ========= YAPAY ZEKA Ä°LE METÄ°N OLUÅTUR ========= */
async function generateTextFromAPI(){
  const apiKey = getApiKey();
  updateApiStatusLine();

  if(!apiKey){
    alert("API anahtarÄ± kayÄ±tlÄ± deÄŸil. Bu sayfadan API anahtarÄ±nÄ± doÄŸrulayÄ±n ve kaydedin.");
    return;
  }

  const ageGroup = ageGroupInput.value;
  const level    = levelInput.value;
  const topic    = topicInput.value.trim();

  if(!ageGroup || !level || !topic){
    alert("YaÅŸ aralÄ±ÄŸÄ±, zorluk seviyesi ve konu giriniz.");
    return;
  }

  stop();
  resetSpeedTimer();
  textDisplay.innerHTML = "";
  questionContainer.innerHTML = "";
  quizStatsPanel.innerHTML = "Test sonucu yok.";
  generateStatus.innerText = "Metin oluÅŸturuluyor...";
  generateStatus.style.color = "black";

  quizPhase = "reading";
  questionsGenerated = false;
  currentQuestions = [];
  readyFileQuestions = [];
  userAnswers = [];
  finishBtn.style.display = "none";
  finishBtn.disabled = false;
  readingDoneBtn.style.display = "none";
  resetFreeTimer();

  const levelRules = getTextLevelRules(ageGroup, level);

  const prompt = `
${ageGroup} yaÅŸ aralÄ±ÄŸÄ±ndaki bir Ã¶ÄŸrenci iÃ§in, "${topic}" konusunda TÃ¼rkÃ§e bir Ã¶ÄŸretici metin yaz.

Genel kurallar:
- YaklaÅŸÄ±k 400â€“500 kelime olsun.
- BaÅŸlÄ±k mutlaka olsun.
- Markdown formatÄ± kullanma.
- Liste, madde imi, kod bloÄŸu kullanma.
- BAÅLIKTA VE METÄ°NDE ASLA '#' KARAKTERÄ° KULLANMA.
- Metin normal paragraf yapÄ±sÄ±nda olsun.

YaÅŸ ve zorluk kurallarÄ±:
${levelRules}

En sonda kÄ±sa bir kapanÄ±ÅŸ cÃ¼mlesi yaz.
`;

  try{
    const res = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + apiKey
      },
      body:JSON.stringify({
        model:"gpt-4o-mini",
        messages:[{role:"user",content:prompt}],
        max_tokens:900,
        temperature:0.8
      })
    });

    const data = await res.json();
    let raw = data.choices?.[0]?.message?.content || "";
    raw = raw.replace(/^#+\s*/gm,"");

    rawText = raw;
    loadText(rawText);

    if(currentReadMode === "free"){
      hideAllWords();
      resetFreeTimer();
      const stats = computeBasicTextStats();
      if(stats){
        wordStats.innerHTML =
          `Toplam: ${stats.total}<br>` +
          `${formatSpeedLine(0)}<br>` +
          `SÃ¼re: 0 sn`;
      }
      readingDoneBtn.style.display = "none";
    }else{
      calculateWordStats();
      readingDoneBtn.style.display = "none";
    }

    generateStatus.innerText = "âœ… Metin hazÄ±r.";
    generateStatus.style.color = "green";
  }catch(err){
    console.error(err);
    alert("Hata: " + err.message);
    generateStatus.innerText = "Hata oluÅŸtu.";
    generateStatus.style.color = "red";
  }
}

/* ========= HAZIR METÄ°N SORU PARSE ========= */
function parseQuestionsFromFile(raw){
  const result = [];
  if(!raw) return result;

  const lines = raw
    .split(/\r?\n/)
    .map(l => l.trim());

  let i = 0;
  while (i < lines.length) {

    while (i < lines.length && !lines[i]) i++;
    if (i >= lines.length) break;

    let qLine = lines[i];
    i++;

    qLine = qLine.replace(/^\d+\)\s*/, "").trim();
    if (!qLine) continue;

    const opts = [];
    let optCount = 0;

    while (i < lines.length && optCount < 5) {
      const line = lines[i];
      const m = line.match(/^([a-eA-E])\)\s*(.+)$/);
      if (!m) break;

      const text = m[2].trim();
      opts.push(text);
      optCount++;
      i++;
    }

    if (opts.length !== 5) {
      continue;
    }

    while (i < lines.length && !lines[i]) i++;
    if (i >= lines.length) break;

    let ansLine = lines[i];
    let ansMatch = ansLine.match(/^[a-eA-E]$/);
    let answer = null;

    if (ansMatch) {
      answer = ansMatch[0].toUpperCase();
      i++;
    }

    if (!answer || !["A","B","C","D","E"].includes(answer)) {
      continue;
    }

    result.push({
      q: qLine,
      options: opts,
      answer: answer
    });
  }

  return result;
}

/* ========= HAZIR METÄ°N YÃœKLE ========= */
async function loadReadyText(){
  const sel = readyTextSelect.value;
  if(!sel){
    alert("LÃ¼tfen listeden bir metin seÃ§iniz.");
    return;
  }

  stop();
  resetSpeedTimer();
  textDisplay.innerHTML = "";
  questionContainer.innerHTML = "";
  quizStatsPanel.innerHTML = "Test sonucu yok.";
  generateStatus.innerText = "Metin yÃ¼kleniyor...";
  generateStatus.style.color = "black";

  quizPhase = "reading";
  questionsGenerated = false;
  currentQuestions = [];
  readyFileQuestions = [];
  userAnswers = [];
  finishBtn.style.display = "none";
  finishBtn.disabled = false;
  readingDoneBtn.style.display = "none";
  resetFreeTimer();

  try{
    const res = await fetch(sel);
    const txt = await res.text();

    const marker = "-SORULAR-";
    let textPart = txt;
    let questionsPart = "";

    const idx = txt.indexOf(marker);
    if(idx >= 0){
      textPart = txt.slice(0, idx).trim();
      questionsPart = txt.slice(idx + marker.length).trim();
    }

    rawText = textPart;
    readyFileQuestions = parseQuestionsFromFile(questionsPart);

    loadText(rawText);

    if(currentReadMode === "free"){
      hideAllWords();
      const stats = computeBasicTextStats();
      if(stats){
        wordStats.innerHTML =
          `Toplam: ${stats.total}<br>` +
          `${formatSpeedLine(0)}<br>` +
          `SÃ¼re: 0 sn`;
      }else{
        wordStats.innerHTML =
          `Toplam: 0<br>` +
          `${formatSpeedLine(0)}<br>` +
          `SÃ¼re: 0 sn`;
      }
    }else{
      calculateWordStats();
    }

    generateStatus.innerText = "âœ… Metin yÃ¼klendi.";
    generateStatus.style.color = "green";
  }catch(err){
    console.error(err);
    alert("Metin yÃ¼klenirken hata oluÅŸtu: " + err.message);
    generateStatus.innerText = "Hata oluÅŸtu.";
    generateStatus.style.color = "red";
  }
}

/* ========= BLOK OKUMA VERÄ° YAPISI ========= */
function loadText(txt){
  textDisplay.innerHTML = "";
  words = [];
  currentIndex = 0;

  txt.split(/\r?\n\s*\r?\n|[\r\n]+/).forEach(line=>{
    const div = document.createElement("div");
    div.className = "line";
    const lineWords = line.trim().split(/\s+/);
    lineWords.forEach((w,i)=>{
      if(!w) return;
      const span = document.createElement("span");
      span.textContent = w + " ";
      span.className   = "hiddenWord";
      span.dataset.isParagraphStart = (i === 0);
      span.dataset.isSentenceEnd    = /[.!?,;â€¦]$/.test(w);
      words.push(span);
      div.appendChild(span);
    });
    textDisplay.appendChild(div);
  });
}

/* ========= Ä°STATÄ°STÄ°K (HIZ MODU â€“ BLOK BAZLI, KISMÄ° BLOKTA ORANLI) ========= */
timeInput.addEventListener("input", calculateWordStats);
blockCountInput.addEventListener("input", calculateWordStats);

function calculateWordStats(){
  const stats = computeBasicTextStats();
  if(!stats){
    wordStats.innerHTML =
      `Toplam: 0<br>` +
      `${formatSpeedLine(0)}<br>` +
      `SÃ¼re: 0 sn`;
    return;
  }

  const wordsArr = rawText
    .replace(/[^\wÄŸÃ¼ÅŸÃ¶Ã§Ä±Ä°ÄÃœÅÃ–Ã‡]/g," ")
    .split(/\s+/)
    .filter(Boolean);

  if(!wordsArr.length){
    wordStats.innerHTML =
      `Toplam: 0<br>` +
      `${formatSpeedLine(0)}<br>` +
      `SÃ¼re: 0 sn`;
    return;
  }

  const X = +timeInput.value || 300; // ms
  const desiredBlocks = Math.min(3, Math.max(1, parseInt(blockCountInput.value, 10) || 1));

  let totalTimeMs = 0;
  let idx = 0;

  while(idx < wordsArr.length){
    const blockWords = wordsArr.slice(idx, idx + desiredBlocks);
    const actualBlocks = blockWords.length;
    if(actualBlocks === 0) break;

    let charCount = 0;
    blockWords.forEach(w => { charCount += w.length; });

    // OranlÄ± sÃ¼re: tam blok X ms, 1/3 blok X*(1/3) ms gibi
    const fraction = actualBlocks / desiredBlocks;
    let baseMs = X * fraction;

    const targetLetters = 5 * actualBlocks; // her blok ~5 harf
    let tBlock = baseMs - ((targetLetters - charCount) * baseMs / 10) * 1.2;
    if(tBlock < 1) tBlock = 1;

    totalTimeMs += tBlock;
    idx += desiredBlocks;
  }

  const minutes = totalTimeMs / 60000;
  const wpm = minutes > 0 ? Math.round(stats.total / minutes) : 0;
  lastCalculatedWpm = wpm;

  wordStats.innerHTML =
    `Toplam: ${stats.total}<br>` +
    `${formatSpeedLine(wpm)}<br>` +
    `SÃ¼re: 0 sn`;
}

/* ========= BLOK SÄ°STEMÄ° (EKRANDA GÃ–STERÄ°RKEN â€“ ORANLI SÃœRE) ========= */
function showNextWord(){
  if(currentReadMode !== "speed") return;
  if(paused) return;

  if(currentIndex >= words.length){
    if(!questionsGenerated && quizPhase === "reading" && currentReadMode === "speed"){
      questionsGenerated = true;
      quizPhase = "questions";

      finalizeSpeedTimer();

      setTimeout(async ()=>{
        const selected = document.querySelector('input[name="textMode"]:checked');
        const selectedMode = selected ? selected.value : "ai";

        if(selectedMode === "ai"){
          await generateQuestionsForText();
          renderQuestions();
        }else{
          currentQuestions = readyFileQuestions || [];
          userAnswers = new Array(currentQuestions.length).fill(null);
          renderQuestions();
        }

        hideAllWords();
        textDisplay.innerHTML = "";
        readingDoneBtn.style.display = "none";

        if(currentQuestions && currentQuestions.length){
          finishBtn.style.display = "inline-block";
          finishBtn.disabled = false;
        }
      }, 300);
    }
    return;
  }

  words.forEach(w=>w.className="hiddenWord");

  const desiredBlocks = Math.min(3, parseInt(blockCountInput.value,10) || 1);
  const blockWords = [];
  let displayed = 0;

  // Ä°lk kelime
  let first = words[currentIndex];
  first.className = "visibleWord";
  blockWords.push(first);
  displayed = 1;

  // SatÄ±r/cÃ¼mle/paragraf kÄ±rÄ±lmasÄ±na gÃ¶re 2. ve 3. kelimeleri ekle
  for(let i=1; i<desiredBlocks; i++){
    if(currentIndex + i >= words.length) break;

    const prev = words[currentIndex + i - 1];
    const next = words[currentIndex + i];

    const sentenceEnd   = prev.dataset.isSentenceEnd === "true";
    const paragraphStart= next.dataset.isParagraphStart === "true";
    const sameLine      = prev.offsetTop === next.offsetTop;

    if(sentenceEnd || paragraphStart || !sameLine) break;

    next.className = "visibleWord";
    blockWords.push(next);
    displayed++;
  }

  const X = +timeInput.value || 300;
  const actualBlocks = blockWords.length;
  let totalChars = 0;
  blockWords.forEach(w=>{
    totalChars += w.textContent.trim().length;
  });

  // desired=3, X=300 => actual=1 ise baseMs=100
  const fraction = actualBlocks / desiredBlocks;
  let baseMs = X * fraction;

  const targetLetters = 5 * actualBlocks;
  let tBlock;
  if(totalChars > 0){
    tBlock = baseMs - ((targetLetters - totalChars) * baseMs / 10) * 1.2;
    if(tBlock < 1) tBlock = 1;
  }else{
    tBlock = baseMs;
  }

  currentIndex += displayed;

  timeoutId = setTimeout(()=>{
    blockWords.forEach(w=>w.className="hiddenWord");
    showNextWord();
  }, tBlock);
}

/* ========= OKUMA BUTONLARI ========= */
function start(){
  if(currentReadMode !== "speed"){
    alert("Serbest okuma modundasÄ±nÄ±z. Metni okuyup 'OkumayÄ± BaÅŸlat' ve ardÄ±ndan 'Okuma Bitti' butonlarÄ±nÄ± kullanÄ±n.");
    return;
  }
  if(!words.length){
    alert("Ã–nce metin oluÅŸturun veya hazÄ±r metin seÃ§in.");
    return;
  }
  paused = false;
  startSpeedTimer();
  showNextWord();
}
function pause(){
  if(currentReadMode !== "speed") return;
  paused = true;
  clearTimeout(timeoutId);
  pauseSpeedTimer();
}
function stop(){
  if(currentReadMode !== "speed"){
    return;
  }
  paused = false;
  clearTimeout(timeoutId);
  currentIndex = 0;
  hideAllWords();
  resetSpeedTimer();
}

startBtn.onclick = start;
pauseBtn.onclick = pause;
stopBtn.onclick  = stop;

/* ========= SERBEST OKUMA: OKUMA BÄ°TTÄ° ========= */
readingDoneBtn.addEventListener("click", async ()=>{
  if(currentReadMode !== "free") return;
  if(!rawText){
    alert("Ã–nce metin oluÅŸturun veya hazÄ±r metin seÃ§in.");
    return;
  }
  if(quizPhase !== "reading") return;

  if(freeReadingStart != null){
    freeElapsedMs = performance.now() - freeReadingStart;
  }
  stopFreeTimerKeepElapsed();
  showFreeFinalStats();

  readingDoneBtn.style.display = "none";
  hideAllWords();
  textDisplay.innerHTML = "";

  quizPhase = "questions";

  if(!currentQuestions.length){
    const selected = document.querySelector('input[name="textMode"]:checked');
    const selectedMode = selected ? selected.value : "ai";

    if(selectedMode === "ai"){
      await generateQuestionsForText();
    }else{
      currentQuestions = readyFileQuestions || [];
      userAnswers = new Array(currentQuestions.length).fill(null);
    }
  }

  renderQuestions();
  if(currentQuestions && currentQuestions.length){
    finishBtn.style.display = "inline-block";
    finishBtn.disabled = false;
  }
});

/* ========= SORU SÄ°STEMÄ° ========= */
finishBtn.addEventListener("click", ()=>{
  if(quizPhase !== "questions") return;
  evaluateQuiz();
  quizPhase = "finished";
  finishBtn.disabled = true;
});

function shuffleOptionsAndFixAnswer(q){
  const answerLetter = (q.answer || "").toString().trim().toUpperCase();
  const correctIdx = ANSWER_LETTERS.indexOf(answerLetter);

  if(correctIdx < 0) return;
  if(!Array.isArray(q.options) || q.options.length !== 5) return;

  const packed = q.options.map((t, i) => ({ t, i }));

  for(let i = packed.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [packed[i], packed[j]] = [packed[j], packed[i]];
  }

  q.options = packed.map(x => x.t);

  const newCorrectPos = packed.findIndex(x => x.i === correctIdx);
  q.answer = ANSWER_LETTERS[newCorrectPos];
}

async function generateQuestionsForText(){
  const apiKey = getApiKey();
  updateApiStatusLine();

  if(!apiKey){
    alert("API anahtarÄ± kayÄ±tlÄ± deÄŸil. Bu sayfadan API anahtarÄ±nÄ± doÄŸrulayÄ±n ve kaydedin.");
    questionContainer.innerHTML = "";
    return;
  }

  if(!rawText){
    questionContainer.innerHTML = "";
    return;
  }

  questionContainer.innerHTML = "Sorular hazÄ±rlanÄ±yor...";

  const ageGroup   = ageGroupInput.value;
  const level      = levelInput.value;
  const levelRules = getQuestionLevelRules(ageGroup, level);

  const prompt = `
${ageGroup || "belirsiz"} yaÅŸ aralÄ±ÄŸÄ±ndaki bir Ã¶ÄŸrenci iÃ§in, aÅŸaÄŸÄ±daki metne gÃ¶re TÃ¼rkÃ§e 10 adet okuduÄŸunu anlama sorusu hazÄ±rla.

Genel kurallar:
- Her soru iÃ§in A, B, C, D ve E ÅŸÄ±klarÄ± olsun.
- ÅÄ±klar kÄ±sa ve net olsun.
- Cevaplar sadece metne dayalÄ± olsun.
- DoÄŸru ÅŸÄ±k harfleri mÃ¼mkÃ¼n olduÄŸunca eÅŸit daÄŸÄ±lmÄ±ÅŸ olsun; 10 soruda her harf (A,B,C,D,E) tercihen 2 kere doÄŸru cevap olsun.

YaÅŸ ve zorluk kurallarÄ±:
${levelRules}

Ã‡Ä±kÄ±ÅŸ kesinlikle sadece JSON olsun, JSON dÄ±ÅŸÄ±nda aÃ§Ä±klama yazma.

Metin:
"""${rawText}"""

JSON formatÄ± tam olarak ÅŸÃ¶yle olsun:
{
  "questions": [
    {
      "q": "Soru metni",
      "options": ["A) ...","B) ...","C) ...","D) ...","E) ..."],
      "answer": "C"
    }
  ]
}
`;

  try{
    const res = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + apiKey
      },
      body:JSON.stringify({
        model:"gpt-4o-mini",
        messages:[{role:"user",content:prompt}],
        max_tokens:1200,
        temperature:0.7
      })
    });

    const data = await res.json();
    let text = data.choices?.[0]?.message?.content || "";

    const idx = text.indexOf("{");
    if(idx > 0) text = text.slice(idx);

    const obj = JSON.parse(text);
    currentQuestions = obj.questions || [];
    userAnswers = new Array(currentQuestions.length).fill(null);

    currentQuestions.forEach(q=>{
      if(Array.isArray(q.options)){
        q.options = q.options.map(t =>
          t.replace(/^[A-E]\)\s*/i,"").trim()
        );
      }
    });

    currentQuestions.forEach(q => shuffleOptionsAndFixAnswer(q));

  }catch(err){
    console.error(err);
    alert("Sorular oluÅŸturulurken hata oluÅŸtu: " + err.message);
    questionContainer.innerHTML = "Sorular yÃ¼klenemedi.";
  }
}

function renderQuestions(){
  questionContainer.innerHTML = "";
  if(!currentQuestions || !currentQuestions.length){
    questionContainer.innerHTML = "GÃ¶sterilecek soru bulunamadÄ±.";
    return;
  }

  const letters = ["A","B","C","D","E"];

  currentQuestions.forEach((qObj, qi)=>{
    const qDiv = document.createElement("div");
    qDiv.className = "question";

    const p = document.createElement("p");
    p.textContent = (qi+1) + ") " + (qObj.q || "");
    qDiv.appendChild(p);

    const optsDiv = document.createElement("div");
    optsDiv.className = "options";

    (qObj.options || []).forEach((optText, oi)=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "optionBtn";
      btn.textContent = letters[oi] + ") " + optText;
      btn.dataset.questionIndex = qi;
      btn.dataset.optionIndex   = oi;

      btn.addEventListener("click", ()=>{
        const siblings = optsDiv.querySelectorAll(".optionBtn");
        siblings.forEach(s=>s.classList.remove("selected"));
        btn.classList.add("selected");
        userAnswers[qi] = oi;
      });

      optsDiv.appendChild(btn);
    });

    qDiv.appendChild(optsDiv);
    questionContainer.appendChild(qDiv);
  });
}

function evaluateQuiz(){
  if(!currentQuestions || !currentQuestions.length) return;

  const letters = ["A","B","C","D","E"];
  let correctCount = 0;
  let wrongCount   = 0;

  const questionDivs = questionContainer.querySelectorAll(".question");

  currentQuestions.forEach((qObj, qi)=>{
    const answerLetter = (qObj.answer || "").toString().trim().toUpperCase();
    const correctIdx   = letters.indexOf(answerLetter);
    const qDiv         = questionDivs[qi];
    if(!qDiv) return;

    const buttons = qDiv.querySelectorAll(".optionBtn");
    buttons.forEach((btn, oi)=>{
      btn.classList.remove("correct","wrong","selected");
      if(oi === correctIdx){
        btn.classList.add("correct");
      }
    });

    const userIdx = userAnswers[qi];
    if(userIdx === null || userIdx === undefined){
      wrongCount++;
    }else{
      if(userIdx === correctIdx){
        correctCount++;
      }else{
        wrongCount++;
        const wrongBtn = buttons[userIdx];
        if(wrongBtn) wrongBtn.classList.add("wrong");
      }
    }
  });

  quizStatsPanel.innerHTML =
    `DoÄŸru: ${correctCount}<br>` +
    `YanlÄ±ÅŸ: ${wrongCount}`;
}
</script>

</body>
</html>
